<launch>
    <!--
    Launch file for Redtail aisim_ros node with SITL APM rover.
    -->


    <!-- Start the joystick node -->
    <node pkg="joy" type="joy_node" name="joy_node">
    </node>


    <arg name="airsim_ip"          default="192.168.2.1" />

    <node pkg="airsim_ros" type="car_image_raw_rgb.py" name="image_raw">
        <param name="~airsim_ip"          value="$(arg airsim_ip)" />
    </node>


    <!-- example launch script for ArduPilotMega based FCU's -->
    <arg name="fcu_url" default="udp://127.0.0.1:14551@14555" />
    <arg name="gcs_url" default="" />
    <arg name="tgt_system" default="1" />
    <arg name="tgt_component" default="1" />
    <arg name="log_output" default="screen" />
    <arg name="fcu_protocol" default="v2.0" />
    <arg name="respawn_mavros" default="false" />

    <include file="$(find mavros)/launch/node.launch">
            <arg name="pluginlists_yaml" value="$(find mavros)/launch/apm_pluginlists.yaml" />
            <arg name="config_yaml" value="$(find mavros)/launch/apm_config.yaml" />

            <arg name="fcu_url" value="$(arg fcu_url)" />
            <arg name="gcs_url" value="$(arg gcs_url)" />
            <arg name="tgt_system" value="$(arg tgt_system)" />
            <arg name="tgt_component" value="$(arg tgt_component)" />
            <!--<arg name="log_output" value="$(arg log_output)" />-->
            <arg name="fcu_protocol" value="$(arg fcu_protocol)" />
            <arg name="respawn_mavros" default="$(arg respawn_mavros)" />
    </include>

    <arg name="prototxt_path" default="/home/chris/mkdev/redtail/models/pretrained/TrailNet_SResNet-18.prototxt"/>
    <arg name="model_path"    default="/home/chris/mkdev/redtail/models/pretrained/TrailNet_SResNet-18.caffemodel" />
    <arg name="input_layer"  default="data" />
    <arg name="output_layer" default="out" />
    <arg name="data_type"    default="fp16" />
    <arg name="debug_mode"   default="false"/>
    <arg name="frame_id"   default="/tf_frame" />

    <node pkg="caffe_ros" type="caffe_ros_node" name="trails_dnn" output="screen">
        <param name="camera_topic"  value="/airsim_ros/image_raw" />
        <param name="prototxt_path" value="$(arg prototxt_path)" />
        <param name="model_path"    value="$(arg model_path)" />
        <param name="input_layer"   value="$(arg input_layer)" />
        <param name="output_layer"  value="$(arg output_layer)" />
        <param name="data_type"     value="$(arg data_type)" />
        <param name="debug_mode"    value="$(arg debug_mode)"/>
        <param name="inp_fmt"       value="RGB" />

    </node>

    <arg name="vehicle_type"          default="apmrover" />
    <arg name="altitude_gain"         default="0" />
    <arg name="linear_speed"          default="2.0" />
    <arg name="linear_speed_scale"    default="250" />
    <arg name="turn_angle_scale"      default="500" />
    <arg name="dnn_turn_angle"        default="55.0" />
    <arg name="dnn_lateralcorr_angle" default="40.0" />
    <arg name="joy_type"              default="xbox_wired" />
    <!-- <arg name="log_output"            default="screen" />-->

    <node pkg="px4_controller" type="px4_controller_node" name="px4_controller" output="$(arg log_output)">
        <param name="vehicle_type"          value="$(arg vehicle_type)" />
        <param name="altitude_gain"         value="$(arg altitude_gain)" />
        <param name="linear_speed"          value="$(arg linear_speed)" />
        <param name="linear_speed_scale"    value="$(arg linear_speed_scale)" />
        <param name="turn_angle_scale"      value="$(arg turn_angle_scale)" />
        <param name="dnn_turn_angle"        value="$(arg dnn_turn_angle)" />
        <param name="dnn_lateralcorr_angle" value="$(arg dnn_lateralcorr_angle)" />
        <param name="joy_type"              value="$(arg joy_type)" />
    </node>

    <node pkg="tf" type="static_transform_publisher" name="tf_publisher" args="0 0 0 3.14 0 0 /map $(arg frame_id) 100"/>

    <!-- Start airsim rc publisher -->
    <node pkg="airsim_ros" type="car_rc.py" name="car_rc">
        <param name="~airsim_ip"          value="$(arg airsim_ip)" />
    </node> 

</launch>
